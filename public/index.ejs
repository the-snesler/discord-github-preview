<!DOCTYPE html>
<html>

<head>
  <title>Discord Profile Preview Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/preact@10.23.1",
        "preact/": "https://esm.sh/preact@10.23.1/",
        "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
      }
    }
  </script>
</head>

<body>
  <div id="app"></div>

  <script>
    window.__CONFIG__ = {
      defaultUserId: '<%= defaultUserId %>',
      inviteUrl: '<%= inviteUrl %>'
    };
  </script>

  <script type="module">
    import { html, render } from 'htm/preact';
    import { useState, useEffect, useCallback, useRef } from 'preact/hooks';

    const { defaultUserId, inviteUrl } = window.__CONFIG__;

    // Reusable ColorInput component
    function ColorInput({ value, onChange, label }) {
      const handlePickerChange = (e) => {
        onChange(e.target.value.toUpperCase());
      };

      const handleTextChange = (e) => {
        onChange(e.target.value);
      };

      const pickerValue = /^#[0-9A-Fa-f]{6}$/i.test(value) ? value : '#000000';

      return html`
        <div class="color-input-group">
          <input type="color" value=${pickerValue} onInput=${handlePickerChange} />
          <input type="text" value=${value} onInput=${handleTextChange} placeholder="#RRGGBB" />
        </div>
      `;
    }

    // Theme section component
    function ThemeSection({ theme, setTheme, nitroColors, setNitroColors, customColors, setCustomColors }) {
      const themes = [
        { value: 'dark', label: 'Dark (default)' },
        { value: 'light', label: 'Light' },
        { value: 'nitroDark', label: 'Nitro Dark' },
        { value: 'nitroLight', label: 'Nitro Light' },
        { value: 'custom', label: 'Custom' }
      ];

      const showNitro = theme === 'nitroDark' || theme === 'nitroLight';
      const showCustom = theme === 'custom';

      return html`
        <div class="section">
          <span class="label">Theme</span>
          <div style="margin-bottom: 15px;">
            ${themes.map(t => html`
              <div class="checkbox-container" key=${t.value}>
                <input
                  type="radio"
                  id=${t.value + 'Theme'}
                  name="themeType"
                  value=${t.value}
                  checked=${theme === t.value}
                  onChange=${() => setTheme(t.value)}
                />
                <label for=${t.value + 'Theme'}>${t.label}</label>
              </div>
            `)}
          </div>

          ${showNitro && html`
            <div style="margin-bottom: 15px;">
              <span class="label">Nitro Colors</span>
              <${ColorInput}
                value=${nitroColors.primary}
                onChange=${(v) => setNitroColors({ ...nitroColors, primary: v })}
              />
              <${ColorInput}
                value=${nitroColors.accent}
                onChange=${(v) => setNitroColors({ ...nitroColors, accent: v })}
              />
            </div>
          `}

          ${showCustom && html`
            <div style="margin-bottom: 15px;">
              <span class="label">Custom Colors</span>
              <${ColorInput}
                value=${customColors.b1}
                onChange=${(v) => setCustomColors({ ...customColors, b1: v })}
              />
              <${ColorInput}
                value=${customColors.b2}
                onChange=${(v) => setCustomColors({ ...customColors, b2: v })}
              />
              <${ColorInput}
                value=${customColors.b3}
                onChange=${(v) => setCustomColors({ ...customColors, b3: v })}
              />
              <${ColorInput}
                value=${customColors.t1}
                onChange=${(v) => setCustomColors({ ...customColors, t1: v })}
              />
              <${ColorInput}
                value=${customColors.t2}
                onChange=${(v) => setCustomColors({ ...customColors, t2: v })}
              />
            </div>
          `}
        </div>
      `;
    }

    // Build preview URL from state
    function buildPreviewUrl(state) {
      const params = new URLSearchParams();

      if (state.enableAboutMe && state.aboutMe) {
        params.append('aboutMe', state.aboutMe);
      }
      if (state.overrideBanner && state.bannerUrl) {
        params.append('banner', state.bannerUrl);
      }
      if (state.hideDecoration) {
        params.append('hideDecoration', 'true');
      }
      if (state.hideSpotify) {
        params.append('hideSpotify', 'true');
      }

      params.append('theme', state.theme);

      if (state.theme === 'nitroDark' || state.theme === 'nitroLight') {
        params.append('primaryColor', state.nitroColors.primary.replace(/^#/, ''));
        params.append('accentColor', state.nitroColors.accent.replace(/^#/, ''));
      } else if (state.theme === 'custom') {
        params.append('colorB1', state.customColors.b1.replace(/^#/, ''));
        params.append('colorB2', state.customColors.b2.replace(/^#/, ''));
        params.append('colorB3', state.customColors.b3.replace(/^#/, ''));
        params.append('colorT1', state.customColors.t1.replace(/^#/, ''));
        params.append('colorT2', state.customColors.t2.replace(/^#/, ''));
      }

      if (state.width) {
        params.append('width', state.width.toString());
      }

      const base = `/api/user/${state.userId}`;
      const queryString = params.toString();
      return queryString ? `${base}?${queryString}` : base;
    }

    // Main App component
    function App() {
      // Form state
      const [userId, setUserId] = useState(defaultUserId);
      const [enableAboutMe, setEnableAboutMe] = useState(false);
      const [aboutMe, setAboutMe] = useState('');
      const [hideDecoration, setHideDecoration] = useState(false);
      const [hideSpotify, setHideSpotify] = useState(false);
      const [theme, setTheme] = useState('dark');
      const [nitroColors, setNitroColors] = useState({ primary: '#8180ff', accent: '#fe80c0' });
      const [customColors, setCustomColors] = useState({
        b1: '#111214',
        b2: '#313338',
        b3: '#505059',
        t1: '#ffffff',
        t2: '#d2d6d8'
      });
      const [width, setWidth] = useState('512');
      const [overrideBanner, setOverrideBanner] = useState(false);
      const [bannerUrl, setBannerUrl] = useState('');

      // UI state
      const [copySuccess, setCopySuccess] = useState(false);
      const [previewSrc, setPreviewSrc] = useState(`/api/user/${defaultUserId}`);
      const [markdownUrl, setMarkdownUrl] = useState('');
      const [rawUrl, setRawUrl] = useState('');
      const [previewOpacity, setPreviewOpacity] = useState(1);

      // Track last fetched username to avoid redundant API calls
      const usernameCache = useRef({ id: '', username: '' });

      // Generate preview handler
      const generatePreview = useCallback(async (silent = false) => {
        if (!/^\d{17,}$/.test(userId)) {
          if (!silent) alert('Please enter a valid Discord User ID.');
          return;
        }

        setPreviewOpacity(0.5);

        const state = {
          userId,
          enableAboutMe,
          aboutMe,
          hideDecoration,
          hideSpotify,
          theme,
          nitroColors,
          customColors,
          width,
          overrideBanner,
          bannerUrl
        };

        const url = buildPreviewUrl(state);

        try {
          // Only fetch username if userId changed
          let username = usernameCache.current.username;
          if (usernameCache.current.id !== userId) {
            const response = await fetch(`/api/username/${userId}`);
            if (!response.ok) throw new Error('Failed to fetch username');
            const data = await response.json();
            username = data.username;
            usernameCache.current = { id: userId, username };
          }

          // Preload image
          await new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = resolve;
            img.onerror = reject;
            img.src = url;
          });

          const fullUrl = window.location.origin + url;
          setPreviewSrc(url);
          setRawUrl(fullUrl);
          setMarkdownUrl(`[![${username}'s Discord status](${fullUrl})](https://github.com/TetraTsunami/discord-github-preview)`);
          setPreviewOpacity(1);
        } catch (error) {
          console.error('Error:', error);
          if (!silent) alert('Failed to generate preview. Please check the User ID and try again.');
          setPreviewOpacity(1);
        }
      }, [userId, enableAboutMe, aboutMe, hideDecoration, hideSpotify, theme, nitroColors, customColors, width, overrideBanner, bannerUrl]);

      // Copy URL handler
      const copyUrl = useCallback(async () => {
        if (!markdownUrl) return;

        try {
          await navigator.clipboard.writeText(markdownUrl);
          setCopySuccess(true);
          setTimeout(() => setCopySuccess(false), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
          alert('Failed to copy URL');
        }
      }, [markdownUrl]);

      // Auto-regenerate preview with debounce when form changes
      useEffect(() => {
        const timeout = setTimeout(() => {
          generatePreview(true);
        }, 500);
        return () => clearTimeout(timeout);
      }, [generatePreview]);

      // Keyboard shortcut for manual refresh
      useEffect(() => {
        const handler = (e) => {
          if (e.ctrlKey && e.key === 'Enter') {
            generatePreview(false);
          }
        };
        document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
      }, [generatePreview]);

      return html`
        <div class="container">
          <h1>Discord Profile Preview Generator</h1>
          <p class="description">Generate a preview of your Discord profile for use on GitHub or other platforms.</p>
          <p class="callout callout-warn">
            ⚠️ Before starting, <a href="${inviteUrl}" target="_blank">join the Discord server</a> so the bot can access your profile information.
          </p>

          <div class="controls">
            <div class="column">
              <div class="section">
                <span class="label">User ID</span>
                <input
                  type="text"
                  value=${userId}
                  onInput=${(e) => setUserId(e.target.value)}
                  placeholder="Discord User ID"
                />
              </div>

              <div class="section">
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="enableAboutMe"
                    checked=${enableAboutMe}
                    onChange=${(e) => setEnableAboutMe(e.target.checked)}
                  />
                  <label for="enableAboutMe">Enable About Me</label>
                </div>

                <span class="label">About Me</span>
                <textarea
                  value=${aboutMe}
                  onInput=${(e) => setAboutMe(e.target.value)}
                  placeholder="About me content..."
                  disabled=${!enableAboutMe}
                />
              </div>

              <div class="section">
                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="hideDecoration"
                    checked=${hideDecoration}
                    onChange=${(e) => setHideDecoration(e.target.checked)}
                  />
                  <label for="hideDecoration">Hide Avatar Decoration</label>
                </div>

                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="hideSpotify"
                    checked=${hideSpotify}
                    onChange=${(e) => setHideSpotify(e.target.checked)}
                  />
                  <label for="hideSpotify">Hide Spotify Activity</label>
                </div>
              </div>

              <${ThemeSection}
                theme=${theme}
                setTheme=${setTheme}
                nitroColors=${nitroColors}
                setNitroColors=${setNitroColors}
                customColors=${customColors}
                setCustomColors=${setCustomColors}
              />

              <div class="section">
                <span class="label">Image Options</span>
                <div style="margin-bottom: 12px;">
                  <label class="label" for="widthInput">Width (px)</label>
                  <input
                    type="number"
                    id="widthInput"
                    min="128"
                    max="2048"
                    step="1"
                    value=${width}
                    onInput=${(e) => setWidth(e.target.value)}
                    placeholder="Width in pixels"
                  />
                </div>

                <div class="checkbox-container">
                  <input
                    type="checkbox"
                    id="overrideBanner"
                    checked=${overrideBanner}
                    onChange=${(e) => setOverrideBanner(e.target.checked)}
                  />
                  <label for="overrideBanner">Override Banner</label>
                </div>

                <span class="label">Banner URL</span>
                <input
                  type="text"
                  value=${bannerUrl}
                  onInput=${(e) => setBannerUrl(e.target.value)}
                  placeholder="https://example.com/banner.png"
                  disabled=${!overrideBanner}
                />
              </div>
            </div>

            <div class="column">
              <div class="section">
                <span class="label">Preview</span>
                <div class="preview">
                  <img
                    src=${previewSrc}
                    alt="Discord Profile Preview"
                    style=${{ opacity: previewOpacity }}
                  />
                </div>
              </div>

              <div class="section">
                <span class="label">Markdown URL (for GitHub)</span>
                <div class="result-box">${markdownUrl}</div>
                <button
                  onClick=${copyUrl}
                  class=${copySuccess ? 'copy-success' : ''}
                  style="margin-top: 12px;"
                >
                  ${copySuccess ? 'Copied!' : 'Copy Markdown URL'}
                </button>
              </div>

              <div class="section">
                <span class="label">Raw URL</span>
                <div class="result-box">${rawUrl}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Mount the app
    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>

</html>
